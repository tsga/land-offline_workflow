geometry:
  fms initialization:
    namelist filename: Data/fv3files/fmsmpp.nml
    field table filename: Data/fv3files/field_table_lam_cmaq
  akbk: Data/fv3files/akbkXXNPZ.nc4
  npx: XXNPX
  npy: XXNPY
  npz: XXNPZ
  ntiles: 6
  layout: [4,4]
  io_layout: [1,1]
#  layout   = 1,2
#  io_layout = 1,1
  field metadata override: Data/fieldmetadata/snow.yaml  #gfs-land.yaml

  time invariant fields:
    state fields:
      datetime: XXYYYY-XXMM-XXDDTXXHH:00:00Z
      filetype: fms restart
      skip coupler file: true
      state variables: [orog_filt]
      datapath: XXTPATH
#/scratch1/NCEPDEV/global/glopara/fix/orog/20220805/C768.mx025_frac/
      filename_orog: XXTSTUB 
#oro_C768.mx025.nc
    derived fields: [nominal_surface_pressure]

time window:
  begin: 'XXYYYP-XXMP-XXDPTXXHP:00:00Z'
  length: PTXXDTH

background:
 date: &date XXYYYY-XXMM-XXDDTXXHH:00:00Z
 members:
   - datetime: XXYYYY-XXMM-XXDDTXXHH:00:00Z
     filetype: fms restart
     state variables: [snwdph,vtype,slmsk] #,sheleg,snowxy,sneqvoxy,zsnsoxy,tsnoxy,snicexy,snliqxy,stc,smc,slc,tgxy]
     datapath: input/bg/C768/mem001
     filename_sfcd: XXYYYYXXMMXXDD.XXHH0000.sfc_data.nc
     filename_cplr: XXYYYYXXMMXXDD.XXHH0000.coupler.res
   - datetime: XXYYYY-XXMM-XXDDTXXHH:00:00Z
     filetype: fms restart
     state variables: [snwdph,vtype,slmsk] #,sheleg,snowxy,sneqvoxy,zsnsoxy,tsnoxy,snicexy,snliqxy,stc,smc,slc,tgxy]
     datapath: input/bg/C768/mem002
     filename_sfcd: XXYYYYXXMMXXDD.XXHH0000.sfc_data.nc
     filename_cplr: XXYYYYXXMMXXDD.XXHH0000.coupler.res
   - datetime: XXYYYY-XXMM-XXDDTXXHH:00:00Z
     filetype: fms restart
     state variables: [snwdph,vtype,slmsk] #,sheleg,snowxy,sneqvoxy,zsnsoxy,tsnoxy,snicexy,snliqxy,stc,smc,slc,tgxy]
     datapath: input/bg/C768/mem003
     filename_sfcd: XXYYYYXXMMXXDD.XXHH0000.sfc_data.nc
     filename_cplr: XXYYYYXXMMXXDD.XXHH0000.coupler.res
   - datetime: XXYYYY-XXMM-XXDDTXXHH:00:00Z
     filetype: fms restart
     state variables: [snwdph,vtype,slmsk] #,sheleg,snowxy,sneqvoxy,zsnsoxy,tsnoxy,snicexy,snliqxy,stc,smc,slc,tgxy]
     datapath: input/bg/C768/mem004
     filename_sfcd: XXYYYYXXMMXXDD.XXHH0000.sfc_data.nc
     filename_cplr: XXYYYYXXMMXXDD.XXHH0000.coupler.res
   - datetime: XXYYYY-XXMM-XXDDTXXHH:00:00Z
     filetype: fms restart
     state variables: [snwdph,vtype,slmsk] #,sheleg,snowxy,sneqvoxy,zsnsoxy,tsnoxy,snicexy,snliqxy,stc,smc,slc,tgxy]
     datapath: input/bg/C768/mem005
     filename_sfcd: XXYYYYXXMMXXDD.XXHH0000.sfc_data.nc
     filename_cplr: XXYYYYXXMMXXDD.XXHH0000.coupler.res
   - datetime: XXYYYY-XXMM-XXDDTXXHH:00:00Z
     filetype: fms restart
     state variables: [snwdph,vtype,slmsk] #,sheleg,snowxy,sneqvoxy,zsnsoxy,tsnoxy,snicexy,snliqxy,stc,smc,slc,tgxy]
     datapath: input/bg/C768/mem006
     filename_sfcd: XXYYYYXXMMXXDD.XXHH0000.sfc_data.nc
     filename_cplr: XXYYYYXXMMXXDD.XXHH0000.coupler.res
   - datetime: XXYYYY-XXMM-XXDDTXXHH:00:00Z
     filetype: fms restart
     state variables: [snwdph,vtype,slmsk] #,sheleg,snowxy,sneqvoxy,zsnsoxy,tsnoxy,snicexy,snliqxy,stc,smc,slc,tgxy]
     datapath: input/bg/C768/mem007
     filename_sfcd: XXYYYYXXMMXXDD.XXHH0000.sfc_data.nc
     filename_cplr: XXYYYYXXMMXXDD.XXHH0000.coupler.res
   - datetime: XXYYYY-XXMM-XXDDTXXHH:00:00Z
     filetype: fms restart
     state variables: [snwdph,vtype,slmsk] #,sheleg,snowxy,sneqvoxy,zsnsoxy,tsnoxy,snicexy,snliqxy,stc,smc,slc,tgxy]
     datapath: input/bg/C768/mem008
     filename_sfcd: XXYYYYXXMMXXDD.XXHH0000.sfc_data.nc
     filename_cplr: XXYYYYXXMMXXDD.XXHH0000.coupler.res
   - datetime: XXYYYY-XXMM-XXDDTXXHH:00:00Z
     filetype: fms restart
     state variables: [snwdph,vtype,slmsk] #,sheleg,snowxy,sneqvoxy,zsnsoxy,tsnoxy,snicexy,snliqxy,stc,smc,slc,tgxy]
     datapath: input/bg/C768/mem009
     filename_sfcd: XXYYYYXXMMXXDD.XXHH0000.sfc_data.nc
     filename_cplr: XXYYYYXXMMXXDD.XXHH0000.coupler.res
   - datetime: XXYYYY-XXMM-XXDDTXXHH:00:00Z
     filetype: fms restart
     state variables: [snwdph,vtype,slmsk] #,sheleg,snowxy,sneqvoxy,zsnsoxy,tsnoxy,snicexy,snliqxy,stc,smc,slc,tgxy]
     datapath: input/bg/C768/mem010
     filename_sfcd: XXYYYYXXMMXXDD.XXHH0000.sfc_data.nc
     filename_cplr: XXYYYYXXMMXXDD.XXHH0000.coupler.res
   - datetime: XXYYYY-XXMM-XXDDTXXHH:00:00Z
     filetype: fms restart
     state variables: [snwdph,vtype,slmsk] #,sheleg,snowxy,sneqvoxy,zsnsoxy,tsnoxy,snicexy,snliqxy,stc,smc,slc,tgxy]
     datapath: input/bg/C768/mem011
     filename_sfcd: XXYYYYXXMMXXDD.XXHH0000.sfc_data.nc
     filename_cplr: XXYYYYXXMMXXDD.XXHH0000.coupler.res
   - datetime: XXYYYY-XXMM-XXDDTXXHH:00:00Z
     filetype: fms restart
     state variables: [snwdph,vtype,slmsk] #,sheleg,snowxy,sneqvoxy,zsnsoxy,tsnoxy,snicexy,snliqxy,stc,smc,slc,tgxy]
     datapath: input/bg/C768/mem012
     filename_sfcd: XXYYYYXXMMXXDD.XXHH0000.sfc_data.nc
     filename_cplr: XXYYYYXXMMXXDD.XXHH0000.coupler.res
   - datetime: XXYYYY-XXMM-XXDDTXXHH:00:00Z
     filetype: fms restart
     state variables: [snwdph,vtype,slmsk] #,sheleg,snowxy,sneqvoxy,zsnsoxy,tsnoxy,snicexy,snliqxy,stc,smc,slc,tgxy]
     datapath: input/bg/C768/mem013
     filename_sfcd: XXYYYYXXMMXXDD.XXHH0000.sfc_data.nc
     filename_cplr: XXYYYYXXMMXXDD.XXHH0000.coupler.res
   - datetime: XXYYYY-XXMM-XXDDTXXHH:00:00Z
     filetype: fms restart
     state variables: [snwdph,vtype,slmsk] #,sheleg,snowxy,sneqvoxy,zsnsoxy,tsnoxy,snicexy,snliqxy,stc,smc,slc,tgxy]
     datapath: input/bg/C768/mem014
     filename_sfcd: XXYYYYXXMMXXDD.XXHH0000.sfc_data.nc
     filename_cplr: XXYYYYXXMMXXDD.XXHH0000.coupler.res
   - datetime: XXYYYY-XXMM-XXDDTXXHH:00:00Z
     filetype: fms restart
     state variables: [snwdph,vtype,slmsk] #,sheleg,snowxy,sneqvoxy,zsnsoxy,tsnoxy,snicexy,snliqxy,stc,smc,slc,tgxy]
     datapath: input/bg/C768/mem015
     filename_sfcd: XXYYYYXXMMXXDD.XXHH0000.sfc_data.nc
     filename_cplr: XXYYYYXXMMXXDD.XXHH0000.coupler.res
   - datetime: XXYYYY-XXMM-XXDDTXXHH:00:00Z
     filetype: fms restart
     state variables: [snwdph,vtype,slmsk] #,sheleg,snowxy,sneqvoxy,zsnsoxy,tsnoxy,snicexy,snliqxy,stc,smc,slc,tgxy]
     datapath: input/bg/C768/mem016
     filename_sfcd: XXYYYYXXMMXXDD.XXHH0000.sfc_data.nc
     filename_cplr: XXYYYYXXMMXXDD.XXHH0000.coupler.res
   - datetime: XXYYYY-XXMM-XXDDTXXHH:00:00Z
     filetype: fms restart
     state variables: [snwdph,vtype,slmsk] #,sheleg,snowxy,sneqvoxy,zsnsoxy,tsnoxy,snicexy,snliqxy,stc,smc,slc,tgxy]
     datapath: input/bg/C768/mem017
     filename_sfcd: XXYYYYXXMMXXDD.XXHH0000.sfc_data.nc
     filename_cplr: XXYYYYXXMMXXDD.XXHH0000.coupler.res
   - datetime: XXYYYY-XXMM-XXDDTXXHH:00:00Z
     filetype: fms restart
     state variables: [snwdph,vtype,slmsk] #!,sheleg,snowxy,sneqvoxy,zsnsoxy,tsnoxy,snicexy,snliqxy,stc,smc,slc,tgxy]
     datapath: input/bg/C768/mem018
     filename_sfcd: XXYYYYXXMMXXDD.XXHH0000.sfc_data.nc
     filename_cplr: XXYYYYXXMMXXDD.XXHH0000.coupler.res
   - datetime: XXYYYY-XXMM-XXDDTXXHH:00:00Z
     filetype: fms restart
     state variables: [snwdph,vtype,slmsk] #!,sheleg,snowxy,sneqvoxy,zsnsoxy,tsnoxy,snicexy,snliqxy,stc,smc,slc,tgxy]
     datapath: input/bg/C768/mem019
     filename_sfcd: XXYYYYXXMMXXDD.XXHH0000.sfc_data.nc
     filename_cplr: XXYYYYXXMMXXDD.XXHH0000.coupler.res
   - datetime: XXYYYY-XXMM-XXDDTXXHH:00:00Z
     filetype: fms restart
     state variables: [snwdph,vtype,slmsk] #!,sheleg,snowxy,sneqvoxy,zsnsoxy,tsnoxy,snicexy,snliqxy,stc,smc,slc,tgxy]
     datapath: input/bg/C768/mem020
     filename_sfcd: XXYYYYXXMMXXDD.XXHH0000.sfc_data.nc
     filename_cplr: XXYYYYXXMMXXDD.XXHH0000.coupler.res

observations:
  observers:
  - obs space:
      name: SnowDepthGHCN
      distribution:
        name: Halo  #InefficientDistribution  #Halo
        halo size: 250e3
      simulated variables: [totalSnowDepth]
      obsdatain:
        engine:
          type: H5File
          obsfile: GHCN/EVEXC/V4/ghcn_full_snwd_ioda_XXYYYYXXMMXXDD.nc
          #obsfile: GHCN/V3/StationElevation/ghcn_snwd_ioda_XXYYYYXXMMXXDD.nc
          #obsfile: GHCN/EVAL/V5/eval_ghcn_full_snwd_ioda_XXYYYYXXMMXXDD.nc
      obsdataout:
        engine:
          type: H5File
          obsfile: output/hofx/letkf_hofx_ghcn_XXYYYYXXMMXXDDXXHH.nc
    obs operator:
      name: Identity
      #interpolation method: nearest-neighbor
      #level index 0 is closest to surface: true
    obs error:
      covariance model: diagonal
    obs localizations:
#    - localization method: Horizontal Gaspari-Cohn
#      lengthscale: 240e3
#      max nobs: 50
    - localization method: Horizontal Box car
      lengthscale: 120e3
      max nobs: 50
    - localization method: Vertical localization
      ioda vertical coordinate: stationElevation
      ioda vertical coordinate group: MetaData
      localization function: Box Car
      vertical lengthscale: 1500
      max nobs: 50
#    - localization method: Horizontal SOAR
#      lengthscale: 120e3
#      soar horizontal decay: 0.0   #0.0000286    #.000021
#      max nobs: 50
#    - localization method: Vertical Brasnett
#      vertical lengthscale: 700
    obs filters:
    - filter: Bounds Check # negative / missing snow
      filter variables:
      - name: totalSnowDepth
      minvalue: 0.0
      maxvalue: 100000
    - filter: Domain Check # missing station elevation (-999.9)
      where:
      - variable:
          name: MetaData/stationElevation
        minvalue: -999.0
    - filter: Domain Check # land only
      where:
      - variable:
          name: GeoVaLs/slmsk
        minvalue: 0.5
        maxvalue: 1.5
        #    - filter: Domain Check # land only
        #      where:
        #      - variable:
        #          name: GeoVaLs/land_frac
        #        minvalue: 0.9
        #        maxvalue: 1.0
    # GFSv17 only.
    #     #- filter: Domain Check # no sea ice
    #         #  where:
    #             #  - variable:
    #                 #      name: fraction_of_ice@GeoVaLs
    #                     #    maxvalue: 0.0

    - filter: RejectList  # no land-ice
      where:
      - variable:
          name: GeoVaLs/vtype
        minvalue: 14.5
        maxvalue: 15.5
    - filter: RejectList  # no water
      where:
      - variable:
          name: GeoVaLs/vtype
        minvalue: 16.5
        maxvalue: 17.5
    - filter: RejectList  # no sea ice
      where:
      - variable:
          name: GeoVaLs/vtype
        minvalue: 19.5
        maxvalue: 20.5
    - filter: Background Check # gross error check
      filter variables:
      - name: totalSnowDepth
      #threshold: 6.25
      absolute threshold: 250
      bias correction parameter: 1.0
      action:
        name: reject
#    - filter: Difference Check
#      reference: ObsValue/totalSnowDepth
#      value: GeoVaLs/totalSnowDepth
#      absolute threshold: 250
#      action:
#        name: reject
        
driver:
  save posterior mean: true
  save posterior mean increment: true
  save posterior ensemble: true
  save posterior ensemble increments: true 
# update obs config is set to true by default (which also implies halo distribution is used)
# need set to false here because halo distribution is NOT used for this run
#  update obs config with geometry info: false
#  run as observer only: true

local ensemble DA:
  solver: LETKF
  inflation:
    rtps: 0.0
    rtpp: 0.0
    mult: 1.0

output:
  date: *date
  filetype: fms restart
  datapath: output/letkf/C768/restart/mem%{member}%
#  prefix: land_anl
  filename_sfcd: sfc_data.nc
  filename_cplr: coupler.res
  state variables: [snwdph,vtype,slmsk] #,sheleg,snowxy,sneqvoxy,zsnsoxy,tsnoxy,snicexy,snliqxy,stc,smc,slc,tgxy]
  #  - snwdph
  #  - vtype
  #  - slmsk
output ensemble increments:
  date: *date
  filetype: fms restart
  datapath: output/letkf/C768/restart/mem%{member}%
  filename_sfcd: xainc.sfc_data.nc
  #  prefix: land_inc
  state variables:
  - snwdph
  - vtype
  - slmsk

output increment:
  date: *date
  filetype: fms restart
  datapath: output/letkf/C768/restart/mem%{member}%
  filename_sfcd: xainc.sfc_data.nc
  #  prefix: land_inc
  state variables:
  - snwdph
  - vtype
  - slmsk
